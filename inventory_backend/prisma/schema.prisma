// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Model User
model User {
  id                   Int           @id @default(autoincrement())
  username             String        @unique
  password             String
  name                 String?
  role                 Role          @default(USER)
  createdAt            DateTime      @default(now())

  items                Item[]        // Barang yang didaftarkan user ini
  transactions         Transaction[] // Riwayat transaksi (Header)
  approvedTransactions Transaction[] @relation("ApproverRelation") 
}

// Model Barang
model Item {
  id           Int               @id @default(autoincrement())
  itemCode     String            @unique
  name         String
  description  String?
  quantity     Int               @default(0)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  deletedAt    DateTime?

  userId       Int
  user         User              @relation(fields: [userId], references: [id])
  
  // Relasi ke Detail Transaksi
  transactionItems TransactionItem[] 
}

// Model Header Transaksi (Satu Transaksi punya Banyak Barang)
model Transaction {
  id            Int               @id @default(autoincrement())
  code          String            @unique 
  type          TransactionType
  status        TransactionStatus
  
  // Dokumen & Info
  documentNo    String            @unique // Nomor Surat Jalan
  externalParty String?           // Vendor / Peminta
  notes         String?           @db.Text
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relasi User
  userId        Int
  user          User              @relation(fields: [userId], references: [id])

  // Admin yang Approve/Reject
  approvedById  Int?
  approver      User?             @relation("ApproverRelation", fields: [approvedById], references: [id])

  // Relasi ke Item-Item (Keranjang)
  items         TransactionItem[]
}

// Model Detail Transaksi (Isi Keranjang / Detail Barang Yang Didalam Satu Transaksi)
model TransactionItem {
  id            Int         @id @default(autoincrement())
  
  transactionId Int
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  itemId        Int
  item          Item        @relation(fields: [itemId], references: [id])
  
  quantity      Int         // Jumlah barang ini dalam transaksi
}

// Role Akun
enum Role {
  ADMIN
  USER
}

// Status Transaksi Barang
enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED 
}

// Tipe Transaksi Barang
enum TransactionType {
  IN
  OUT
}